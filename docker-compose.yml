services:
  # MariaDB - Database
  mariadb:
    image: mariadb:11.8-noble
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb-data:/var/lib/mysql
    networks:
      - wp-network
    command: >
      --innodb-buffer-pool-size=${INNODB_BUFFER_POOL_SIZE}
      --innodb-buffer-pool-instances=${INNODB_BUFFER_POOL_INSTANCES}
      --table-open-cache=${TABLE_OPEN_CACHE}
      --table-definition-cache=${TABLE_DEFINITION_CACHE}
      --innodb-log-file-size=${INNODB_LOG_FILE_SIZE}
      --innodb-log-buffer-size=${INNODB_LOG_BUFFER_SIZE}
      --max-connections=${MAX_CONNECTIONS}
      --thread-cache-size=${THREAD_CACHE_SIZE}
      --sort-buffer-size=${SORT_BUFFER_SIZE}
      --read-buffer-size=${READ_BUFFER_SIZE}
      --read-rnd-buffer-size=${READ_RND_BUFFER_SIZE}
      --max-allowed-packet=${MAX_ALLOWED_PACKET}
      --wait-timeout=${WAIT_TIMEOUT}
      --interactive-timeout=${INTERACTIVE_TIMEOUT}
      --skip-name-resolve
      --performance_schema=OFF
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 100M


  # WordPress with PHP-FPM
  wordpress:
    image: wordpress:fpm
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      WORDPRESS_DB_HOST: mariadb:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
      WORDPRESS_DB_USER: ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WP_ROCKET_CF_API_KEY: ${CF_API_KEY}
      WORDPRESS_CONFIG_EXTRA: |
        if (!defined('WP_DEBUG')) define('WP_DEBUG', ${WP_DEBUG});
        if (!defined('WP_DEBUG_LOG')) define('WP_DEBUG_LOG', ${WP_DEBUG_LOG});
        if (!defined('WP_DEBUG_DISPLAY')) define('WP_DEBUG_DISPLAY', ${WP_DEBUG_DISPLAY});
        if (!defined('WP_CACHE')) define('WP_CACHE', ${WP_CACHE});
        if (!defined('DISABLE_WP_CRON')) define('DISABLE_WP_CRON', ${DISABLE_WP_CRON});
        if (!defined('DISALLOW_FILE_EDIT')) define('DISALLOW_FILE_EDIT', ${DISALLOW_FILE_EDIT});
        if (!defined('FORCE_SSL_LOGIN')) define('FORCE_SSL_LOGIN', ${FORCE_SSL_LOGIN});
        if (!defined('FORCE_SSL_ADMIN')) define('FORCE_SSL_ADMIN', ${FORCE_SSL_ADMIN});
        if (!defined('FS_METHOD')) define('FS_METHOD', '${FS_METHOD}');
        if (!defined('WP_HTTP_BLOCK_EXTERNAL')) define('WP_HTTP_BLOCK_EXTERNAL', ${WP_HTTP_BLOCK_EXTERNAL});
        if (!defined('WP_ACCESSIBLE_HOSTS')) define('WP_ACCESSIBLE_HOSTS', '${WP_ACCESSIBLE_HOSTS}');

        /* Performance & Memory */
        if (!defined('WP_MEMORY_LIMIT')) define('WP_MEMORY_LIMIT', '${WP_MEMORY_LIMIT}');
        if (!defined('WP_MAX_MEMORY_LIMIT')) define('WP_MAX_MEMORY_LIMIT', '${WP_MAX_MEMORY_LIMIT}');
        if (!defined('WP_POST_REVISIONS')) define('WP_POST_REVISIONS', ${WP_POST_REVISIONS});
        if (!defined('EMPTY_TRASH_DAYS')) define('EMPTY_TRASH_DAYS', ${EMPTY_TRASH_DAYS});

        /* PHP Upload & Limits */
        @ini_set('upload_max_filesize', '${PHP_UPLOAD_MAX_FILESIZE}');
        @ini_set('post_max_size', '${PHP_POST_MAX_SIZE}');
        @ini_set('max_execution_time', '300');

        /* Security & Updates */
        if (!defined('AUTOMATIC_UPDATER_DISABLED')) define('AUTOMATIC_UPDATER_DISABLED', ${AUTOMATIC_UPDATER_DISABLED});
        if (!defined('WP_AUTO_UPDATE_CORE')) define('WP_AUTO_UPDATE_CORE', ${WP_AUTO_UPDATE_CORE});

        /* SQLite Object Cache MMAP - Performance */
        if (!defined('WP_SQLITE_OBJECT_CACHE_MMAP_SIZE')) define('WP_SQLITE_OBJECT_CACHE_MMAP_SIZE', ${WP_SQLITE_OBJECT_CACHE_MMAP_SIZE:-0});
        
        /* API Key Cloudflare - WP Rocket */
        if (getenv('WP_ROCKET_CF_API_KEY')) {
            define('WP_ROCKET_CF_API_KEY', getenv('WP_ROCKET_CF_API_KEY'));
            define('WP_ROCKET_CF_API_KEY_HIDDEN', true);
        }

        /* Fix Cloudflare Real IP - Docker Escape */
        if (isset($$_SERVER['HTTP_CF_CONNECTING_IP'])) {
            $$_SERVER['REMOTE_ADDR'] = $$_SERVER['HTTP_CF_CONNECTING_IP'];
        }
    volumes:
      - wordpress-data:/var/www/html
      - ./wordpress/php.ini:/usr/local/etc/php/conf.d/custom.ini
      - ./wordpress/php-fpm.conf:/usr/local/etc/php-fpm.d/zzz-custom.conf
    networks:
      - wp-network
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: "0.5"
        reservations:
          memory: 100M


  # Nginx - Web Server
  nginx:
    image: nginx:1.28-alpine
    restart: unless-stopped
    depends_on:
      - wordpress
    volumes:
      - wordpress-data:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/rocket-nginx:/etc/nginx/rocket-nginx
    networks:
      - wp-network
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: "0.5"
        reservations:
          memory: 12M


# Adminer - Database Management
  adminer:
    image: dockette/adminer:full
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
      ADMINER_DESIGN: pepa-linha-dark
      PHP_CLI_SERVER_WORKERS: 1
    networks:
      - wp-network
    deploy:
      resources:
        limits:
          memory: 32M
          cpus: "0.5"
        reservations:
          memory: 12M


  # File Browser
  filebrowser:
    image: filebrowser/filebrowser:s6
    restart: unless-stopped
    environment:
      - PUID=33
      - PGID=33
    volumes:
      - wordpress-data:/srv
      - ./filebrowser.json:/config/settings.json
      - filebrowser-data:/database
    networks:
      - wp-network
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.5"
        reservations:
          memory: 12M


 # Project Volumes
volumes:
  mariadb-data:
    driver: local
  wordpress-data:
    driver: local
  filebrowser-data:
    driver: local


# Project Networks
networks:
  wp-network:
    driver: bridge
