services:
  # MariaDB - Banco de dados
  mariadb:
    image: mariadb:11.8
    container_name: ${PROJECT_NAME:-wp-site}_mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password_change_me}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-wordpress}
      MYSQL_USER: ${MYSQL_USER:-wordpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-wp_password_change_me}
    volumes:
      - mariadb_data:/var/lib/mysql
    networks:
      - wp_network
    command: >
      --innodb-buffer-pool-size=128M
      --innodb-log-file-size=32M
      --innodb-log-buffer-size=4M
      --max-connections=100
      --query-cache-type=1
      --query-cache-size=16M
      --thread-cache-size=4

  # Redis - Object Cache
  redis:
    image: redis:8.2.2-alpine
    container_name: ${PROJECT_NAME:-wp-site}_redis
    restart: unless-stopped
    command: redis-server --maxmemory 64mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - wp_network

  # WordPress com PHP-FPM
  wordpress:
    image: wordpress:fpm-alpine
    container_name: ${PROJECT_NAME:-wp-site}_wordpress
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      WORDPRESS_DB_HOST: mariadb:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE:-wordpress}
      WORDPRESS_DB_USER: ${MYSQL_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD:-wp_password_change_me}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_CACHE', true);
        define('DISABLE_WP_CRON', true);
        define('DISALLOW_FILE_EDIT', true);
        define('FORCE_SSL_LOGIN', true);
        define('FORCE_SSL_ADMIN', true);
        define('WP_DEBUG', false);
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_TIMEOUT', 1);
        define('WP_REDIS_READ_TIMEOUT', 1);
        define('WP_REDIS_DATABASE', 0);
        define('FS_METHOD', 'direct');
        ini_set('memory_limit', '512M');
        ini_set('upload_max_filesize', '100M');
        ini_set('post_max_size', '100M');
        ini_set('max_execution_time', 300);
    volumes:
      - wordpress_data:/var/www/html
      - ./wordpress/php.ini:/usr/local/etc/php/conf.d/custom.ini
    networks:
      - wp_network
    labels:
      - "wp.cron.job=true"
      - "wp.project=${PROJECT_NAME:-wp-site}"

  # Nginx - Servidor Web
  nginx:
    image: nginx:1.28-alpine
    container_name: ${PROJECT_NAME:-wp-site}_nginx
    restart: unless-stopped
    depends_on:
      - wordpress
    volumes:
      - wordpress_data:/var/www/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - wp_network
    labels:
      - "traefik.enable=false"  # Nginx não será exposto pelo Traefik

  # Varnish - Cache de Página
  varnish:
    image: varnish:latest
    container_name: ${PROJECT_NAME:-wp-site}_varnish
    restart: unless-stopped
    depends_on:
      - nginx
    volumes:
      - ./varnish/default.vcl:/etc/varnish/default.vcl
    command: >
      varnishd -F 
      -f /etc/varnish/default.vcl 
      -s malloc,128m 
      -a :80
    networks:
      - wp_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}.tls.certresolver=cloudflare"
      - "traefik.http.services.${PROJECT_NAME:-wp-site}.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik"

  # Adminer - Gerenciamento de Banco
  adminer:
    image: adminer:latest
    container_name: ${PROJECT_NAME:-wp-site}_adminer
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
      ADMINER_DESIGN: pepa-linha-dark
    networks:
      - wp_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-adminer.rule=Host(`adminer.${DOMAIN}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-adminer.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-adminer.tls.certresolver=cloudflare"
      - "traefik.http.services.${PROJECT_NAME:-wp-site}-adminer.loadbalancer.server.port=8080"
      - "traefik.docker.network=traefik"
      # Middleware de autenticação básica (OBRIGATÓRIO para produção)
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-adminer.middlewares=${PROJECT_NAME:-wp-site}-auth"
      - "traefik.http.middlewares.${PROJECT_NAME:-wp-site}-auth.basicauth.users=${ADMINER_AUTH}"

  # File Browser - Nativo (gera senha automática nos logs)
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: ${PROJECT_NAME:-wp-site}_filebrowser
    restart: unless-stopped
    volumes:
      - wordpress_data:/srv
      - ./filebrowser.json:/.filebrowser.json
      - filebrowser_data:/database
    networks:
      - wp_network
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-files.rule=Host(`files.${DOMAIN}`)"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-files.entrypoints=websecure"
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-files.tls.certresolver=cloudflare"
      - "traefik.http.services.${PROJECT_NAME:-wp-site}-files.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik"
      # Middleware de autenticação básica (OBRIGATÓRIO para produção)
      - "traefik.http.routers.${PROJECT_NAME:-wp-site}-files.middlewares=${PROJECT_NAME:-wp-site}-files-auth"
      - "traefik.http.middlewares.${PROJECT_NAME:-wp-site}-files-auth.basicauth.users=${FILES_AUTH}"

volumes:
  mariadb_data:
    driver: local
  redis_data:
    driver: local
  wordpress_data:
    driver: local
  filebrowser_data:
    driver: local

networks:
  wp_network:
    driver: bridge
  traefik:
    external: true
